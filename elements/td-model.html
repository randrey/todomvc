<!--
    @license
    Copyright (c) 2014 The Polymer Project Authors. All rights reserved.
    This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
    The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
    The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
    Code distributed by Google as part of the polymer project is also
    subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../components/polymer/polymer.html">

<dom-module id="td-model">
	<script>
		Polymer({
			is: 'td-model',
			properties: {
				filter: {
					type: String,
					observer: 'filterChanged'
				},
				items: {
					type: Array,
					observer: 'itemsChanged',
				},
				storageId: {
					type: String,
					observer: 'storageIdChanged'
				},
			},

			filtered: null,
			completedCount: 0,
			activeCount: 0,
			allCompleted: false,
			anyCompleted: false,
			isEmpty: false,

			ready: function() {
				this.async(function() {
					this.set('items', this.storage.value || []);
				});
			},
			filterChanged: function() {
				this.async(function() {
					this.filterItems();
				});
			},
			itemsChanged: function() {
				this.completedCount = this.items.filter(this.filters.completed).length;
				this.activeCount = this.items.length - this.completedCount;
				this.allCompleted = this.completedCount && !this.activeCount;
				this.anyCompleted = this.completedCount > 0;
				this.filterItems();
				if (this.storage) {
					this.storage.value = this.items;
					this.storage.save();
				}
			},
			storageIdChanged: function() {
				this.storage = document.querySelector('#' + this.storageId);
				if (this.storage) {
					this.set('items', this.storage.value);
				}
			},
			filterItems: function() {
				var fn = this.filters[this.filter];
				this.filtered = fn ? this.items.filter(fn) : this.items;
			},
			newItem: function(title) {
				title = String(title).trim();
				if (title) {
					var item = {
						title: title,
						completed: false
					};
					this.push('items', item);
					this.itemsChanged();
				}
			},
			destroyItem: function(item) {
				var i = this.items.indexOf(item);
				if (i >= 0) {
					this.items.splice(i, 1);
				}
				this.itemsChanged();
			},
			clearItems: function (){
				this.items = this.items.filter(this.filters.active);
			},
			setItemsCompleted: function(completed) {
				this.items.forEach(function(item) {
					item.completed = completed;
				});
				this.itemsChanged();
			},
			filters: {
				active: function(item) {
					return !item.completed;
				},
				completed: function(item) {
					return item.completed;
				}
			}
		});
	</script>
</dom-module>
